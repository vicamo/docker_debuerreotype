name: GitHub CI

on:
  pull_request:
  push:
  schedule:
    - cron: 0 0 * * 0
  workflow_dispatch:

defaults:
  run:
    shell: 'bash -Eeuo pipefail -x {0}'

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:

  https:
    name: Ensure no-TLS snapshot usage
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Ensure http://snapshot.debian.org (https://github.com/debuerreotype/debuerreotype/pull/119#issuecomment-901457009)
        run: |
          rm .github/workflows/ci.yml # this file itself will always be a match, but it's the only valid one ðŸ‘€
          if grep -rn 'https://snapshot.debian.org'; then
            exit 1
          fi

  image:
    runs-on: ubuntu-latest
    outputs:
      metadata: ${{ steps.build.outputs.metadata }}
    steps:
      - name: Checkout Debuerreotype
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: v0.12.0
      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: '.'
          outputs: type=docker,dest=/tmp/debuerreotype.tar
          tags: local/debuerreotype:latest

      - name: Upload debuerreotype image tarball
        uses: actions/upload-artifact@v4
        with:
          name: debuerreotype
          path: /tmp/debuerreotype.tar

  test:
    needs:
      - image
    strategy:
      matrix:
        include:
          - { SUITE: stable,    CODENAME: jessie,  TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: d2ce47223c0d1ef7406841b5fdc708debfe83d76d9e1273a9ffb14e8ceb7b391 }
          - { SUITE: jessie,    CODENAME: "",      TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: d2ce47223c0d1ef7406841b5fdc708debfe83d76d9e1273a9ffb14e8ceb7b391 }
          - { SUITE: testing,   CODENAME: stretch, TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: 89ad2c4ff80b7b809e3d5335a77662b296e99599f991a841b8b06db1e6254e5a }
          - { SUITE: stretch,   CODENAME: "",      TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: 89ad2c4ff80b7b809e3d5335a77662b296e99599f991a841b8b06db1e6254e5a }
          - { SUITE: unstable,  CODENAME: sid,     TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: c4c03bc3bb37cd67d51be453a446478ee489388f6a3466fa397d365364105a51 }
          - { SUITE: sid,       CODENAME: "",      TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: c4c03bc3bb37cd67d51be453a446478ee489388f6a3466fa397d365364105a51 }
          - { SUITE: oldstable, CODENAME: wheezy,  TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: 7fc6882ec67a7a8e805c95a4b2a6ee5505fbbb9c8b25f189c43b12653e23d070 }
          - { SUITE: wheezy,    CODENAME: "",      TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: 7fc6882ec67a7a8e805c95a4b2a6ee5505fbbb9c8b25f189c43b12653e23d070 }

          # EOL suites testing
          - { SUITE: eol, CODENAME: etch,  TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: b832acb326673857796e81428eb8bc983e658705a8033672dac3736479b44a96 }
          - { SUITE: eol, CODENAME: lenny, TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: 94b21906842d47aafca69a06ffd1a4c07bd06c263e5d4f22de150f47df13b26d }
          - { SUITE: eol, CODENAME: woody, ARCH: i386, TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: 619c0713182bb56dad5a3922c1b7be89552948bbbc6d8e7f43ed60bac60003fb }
          - { SUITE: eol, CODENAME: jessie, TIMESTAMP: "2021-03-01T00:00:00Z", SHA256: d112c62ae0fca12d4f960fca59e60f92c11ac038d745e2919e2a4d6956085055 }

          # deb822 / usr-is-merged testing
          - { SUITE: unstable, CODENAME: "", TIMESTAMP: "2022-09-30T00:00:00Z", SHA256: a12079acba040281f7110d590a59aa6bd9f8ce77495f1c165d78d9e8acae0fa1 }
          - { SUITE: bookworm, CODENAME: "", TIMESTAMP: "2022-09-30T00:00:00Z", SHA256: eec9cf6b817847686764d0b3143986acd088c6fc8c589eb292d589f86302da16 }
          - { SUITE: bullseye, CODENAME: "", TIMESTAMP: "2022-09-30T00:00:00Z", SHA256: bbaa7762906fc81f34f8c895a64663e9ca42dfc275aba6ec2dc00bef8f6f4969 }

          # qemu-debootstrap testing
          - { ARCH: arm64,   SUITE: jessie,   CODENAME: "", TIMESTAMP: "2017-01-01T00:00:00Z", SHA256: 5e7f66c1cc9bcc36667e221973f0e3d6b21433fdf553760c0f92ec89d256227c }
          - { ARCH: sh4,     SUITE: unstable, CODENAME: "", TIMESTAMP: "2022-02-01T00:00:00Z", SHA256: 9ba1f0ffafc62d73d3aad57e02b9026c8f67d71ea43bafeb403fb07b7cbc7161 }
          - { ARCH: riscv64, SUITE: unstable, CODENAME: "", TIMESTAMP: "2022-02-01T00:00:00Z", SHA256: 3a92f61927dcd9d596aadb210bf127b1654fcae255d902b46674cf0d11ea1b3a }

          # a few entries for "today" to try and catch issues like https://github.com/debuerreotype/debuerreotype/issues/41 sooner
          - { SUITE: unstable,  CODENAME: "", TIMESTAMP: "today 00:00:00", SHA256: "" }
          - { SUITE: stable,    CODENAME: "", TIMESTAMP: "today 00:00:00", SHA256: "" }
          - { SUITE: oldstable, CODENAME: "", TIMESTAMP: "today 00:00:00", SHA256: "" }

          - { DISTRO: ubuntu, SUITE: eol, CODENAME: breezy }
          - { DISTRO: ubuntu, SUITE: eol, CODENAME: gutsy }
          - { DISTRO: ubuntu, SUITE: bionic }
          - { DISTRO: ubuntu, SUITE: eol, CODENAME: cosmic, ARCH: armhf }
          - { DISTRO: ubuntu, SUITE: focal }
          - { DISTRO: ubuntu, SUITE: focal, ARCH: i386 }
          - { DISTRO: ubuntu, SUITE: jammy }
          - { DISTRO: ubuntu, SUITE: noble }
      fail-fast: false
    name: Test ${{ matrix.DISTRO && format('{0} ', matrix.DISTRO) }}${{ matrix.SUITE }}${{ matrix.CODENAME && format(' ({0})', matrix.CODENAME) }}${{ matrix.ARCH && format(' [{0}]', matrix.ARCH) }}${{ matrix.TIMESTAMP && format(' at {0}', matrix.TIMESTAMP) }}
    runs-on: ubuntu-24.04
    env: ${{ matrix }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          version: v0.12.0
      - name: Download debuerreotype image tarball
        uses: actions/download-artifact@v4
        with:
          name: debuerreotype
          path: /tmp
      - name: Load debuerreotype image
        run: docker load --input /tmp/debuerreotype.tar

      - name: Prepare Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -yqq binfmt-support qemu-user-static
          docker run -d --name squignix --restart always tianon/squignix
          git clone --depth 1 https://github.com/tianon/pgp-happy-eyeballs.git ~/phe
          ~/phe/hack-my-builds.sh
          rm -rf ~/phe
      - name: Build
        env:
          IMAGE: ${{ fromJSON(needs.image.outputs.metadata)['image.name'] }}
        run: |
          "./.validate-${DISTRO:-debian}.sh"
